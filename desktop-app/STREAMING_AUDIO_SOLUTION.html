<!doctype html>
<html>
  <head>
    <title>Streaming Audio Solution</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .strategy {
        background: #2a4d2a;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #4caf50;
      }
      .video-container {
        background: #000;
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
      }
      .button {
        background: #e50914;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 18px;
        margin: 10px;
      }
      .sync-status {
        background: #333;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
      }
      .controls {
        background: #333;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .log {
        background: #000;
        color: #0f0;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        margin: 20px 0;
        max-height: 400px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h1>üéµ Streaming Audio Solution</h1>

    <div class="strategy">
      <strong>üöÄ Advanced Strategy:</strong><br />
      1Ô∏è‚É£ Video plays immediately (HEVC direct)<br />
      2Ô∏è‚É£ Audio streams as it transcodes (no waiting!)<br />
      3Ô∏è‚É£ Perfect sync with seeking/controls<br />
      <strong>Result:</strong> Video + Audio start together, stay in sync!
    </div>

    <div>
      <button class="button" onclick="startStreamingPlayback()">üöÄ Start Streaming Playback</button>
      <button class="button" onclick="testDirectFirst()">üì∫ Test Direct First</button>
      <button class="button" onclick="clearLogs()">üóëÔ∏è Clear</button>
    </div>

    <div class="video-container" id="video-container" style="display: none">
      <!-- Main video -->
      <video
        id="main-video"
        controls
        style="width: 100%; height: 400px; background: #000"
        onloadstart="log('üì∫ Video: Loading')"
        oncanplay="log('üì∫ Video: Ready')"
        onplay="log('üì∫ Video: Playing')"
        onpause="log('üì∫ Video: Paused')"
        onseeked="handleVideoSeeked()"
        ontimeupdate="handleTimeUpdate()"
        onerror="log('‚ùå Video error:', event.target.error?.message)"
      ></video>

      <!-- Transcoded audio track -->
      <audio
        id="audio-track"
        style="display: none"
        oncanplay="log('üîä Audio: Ready')"
        onplay="log('üîä Audio: Playing')"
        onpause="log('üîä Audio: Paused')"
        onerror="log('‚ùå Audio error:', event.target.error?.message)"
      ></audio>

      <div class="sync-status" id="sync-status">Sync Status: Ready</div>

      <div class="controls">
        <div id="playback-status">Ready to test</div>
        <div style="margin-top: 15px">
          <button
            onclick="playBoth()"
            style="padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 3px"
          >
            ‚ñ∂Ô∏è Play
          </button>
          <button
            onclick="pauseBoth()"
            style="padding: 8px 15px; background: #ffc107; color: black; border: none; border-radius: 3px"
          >
            ‚è∏Ô∏è Pause
          </button>
          <button
            onclick="seekForward()"
            style="padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 3px"
          >
            ‚è≠Ô∏è +30s
          </button>
          <button
            onclick="seekBackward()"
            style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 3px"
          >
            ‚èÆÔ∏è -30s
          </button>
          <button
            onclick="stopBoth()"
            style="padding: 8px 15px; background: #e50914; color: white; border: none; border-radius: 3px"
          >
            ‚èπÔ∏è Stop
          </button>
        </div>
        <div style="margin-top: 10px">
          <span>Volume: </span>
          <input type="range" min="0" max="1" step="0.1" value="0.8" onchange="setVolume(this.value)" />
          <span style="margin-left: 20px">Sync Offset: </span>
          <input type="range" min="-2" max="2" step="0.1" value="0" onchange="setSyncOffset(this.value)" />
          <span id="offset-display">0.0s</span>
        </div>
      </div>
    </div>

    <div class="log" id="log"></div>

    <script>
      const videoUrl = 'http://89.37.117.6:2095/movie/ngArk2Up/aSh3J7M/1383934.mkv'
      const mainVideo = document.getElementById('main-video')
      const audioTrack = document.getElementById('audio-track')
      const playbackStatus = document.getElementById('playback-status')
      const syncStatus = document.getElementById('sync-status')

      let audioTranscoded = false
      let audioPath = null
      let syncOffset = 0 // Manual sync adjustment
      let lastSyncTime = 0

      function log(message, data = null) {
        const logElement = document.getElementById('log')
        const timestamp = new Date().toLocaleTimeString()
        const logLine = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n`
        logElement.innerHTML += logLine
        logElement.scrollTop = logElement.scrollHeight
        console.log(message, data)
      }

      async function startStreamingPlayback() {
        log('üöÄ Starting STREAMING audio solution...')
        document.getElementById('video-container').style.display = 'block'

        // Start video immediately
        log('1Ô∏è‚É£ Starting video (immediate)...')
        playbackStatus.innerHTML = '1Ô∏è‚É£ Video starting...'

        mainVideo.src = videoUrl

        try {
          await mainVideo.play()
          log('‚úÖ Video playing!')
          playbackStatus.innerHTML = '‚úÖ Video playing - audio transcoding...'

          // Start audio transcoding in parallel (don't wait!)
          transcodeAudioInBackground()
        } catch (error) {
          log('‚ùå Video failed:', error.message)
        }
      }

      async function transcodeAudioInBackground() {
        log('üîä Starting background audio transcoding...')

        if (!window.videoApi) {
          log('‚ùå Video API not available')
          return
        }

        try {
          // Set up real-time progress tracking
          const progressCleanup = window.videoApi.onAudioProgress((progress) => {
            log(`üîÑ Audio: ${progress.percent?.toFixed(1)}% | ${progress.speed}`)
            playbackStatus.innerHTML = `üîä Audio transcoding: ${progress.percent?.toFixed(1)}%`

            // Try to start audio as soon as we have some content
            if (progress.percent > 5 && !audioTranscoded) {
              log('‚ö° Attempting early audio start...')
              tryStartAudio()
            }
          })

          // Start REAL audio transcoding
          const result = await window.videoApi.transcodeAudioOnly(videoUrl)
          progressCleanup()

          if (result.success) {
            log('‚úÖ Audio transcoding completed!')
            audioPath = result.data
            audioTranscoded = true
            startSyncedAudio()
          } else {
            log('‚ùå Audio transcoding failed:', result.error)
          }
        } catch (error) {
          log('‚ùå Audio transcoding error:', error.message)
        }
      }

      function tryStartAudio() {
        // This would try to start audio with partial file
        // For now, wait for completion
        log('‚ö° Waiting for audio completion...')
      }

      function startSyncedAudio() {
        log('üéµ Starting synced audio playback...')

        if (!audioPath) {
          log('‚ùå No audio path available')
          return
        }

        // Set audio source to transcoded file
        audioTrack.src = `file://${audioPath}`

        // Sync with current video time
        audioTrack.currentTime = mainVideo.currentTime + syncOffset

        audioTrack
          .play()
          .then(() => {
            log('üéµ Audio synced and playing!')
            playbackStatus.innerHTML = 'üéä Video + Audio playing!'
            updateSyncStatus()
          })
          .catch((err) => {
            log('‚ùå Audio sync failed:', err.message)
          })
      }

      function handleVideoSeeked() {
        log(`‚è≠Ô∏è Video seeked to: ${mainVideo.currentTime.toFixed(1)}s`)

        if (audioTranscoded && audioTrack.src) {
          // Sync audio to video position
          audioTrack.currentTime = mainVideo.currentTime + syncOffset
          log(`üéµ Audio synced to: ${audioTrack.currentTime.toFixed(1)}s`)
        }
      }

      function handleTimeUpdate() {
        // Update sync status periodically (not too often)
        const now = Date.now()
        if (now - lastSyncTime > 1000) {
          // Update every second
          lastSyncTime = now
          updateSyncStatus()

          // Auto-sync if drift is too large
          if (audioTranscoded && !audioTrack.paused && !mainVideo.paused) {
            const timeDiff = Math.abs(mainVideo.currentTime - audioTrack.currentTime + syncOffset)
            if (timeDiff > 0.5) {
              // More than 500ms drift
              audioTrack.currentTime = mainVideo.currentTime + syncOffset
              log(`üîÑ Auto-sync correction: ${timeDiff.toFixed(2)}s drift`)
            }
          }
        }
      }

      function updateSyncStatus() {
        if (audioTranscoded && audioTrack.src) {
          const videoCurrent = mainVideo.currentTime
          const audioCurrent = audioTrack.currentTime
          const drift = videoCurrent - audioCurrent + syncOffset

          syncStatus.innerHTML = `
                    Video: ${videoCurrent.toFixed(1)}s | 
                    Audio: ${audioCurrent.toFixed(1)}s | 
                    Drift: ${drift.toFixed(2)}s | 
                    Offset: ${syncOffset.toFixed(1)}s
                `
        }
      }

      function playBoth() {
        log('‚ñ∂Ô∏è Playing both tracks...')

        Promise.all([mainVideo.play(), audioTranscoded ? audioTrack.play() : Promise.resolve()])
          .then(() => {
            log('‚úÖ Playback started')
          })
          .catch((err) => {
            log('‚ùå Play failed:', err.message)
          })
      }

      function pauseBoth() {
        mainVideo.pause()
        if (audioTranscoded) audioTrack.pause()
        log('‚è∏Ô∏è Paused')
      }

      function seekForward() {
        const newTime = mainVideo.currentTime + 30
        log(`‚è≠Ô∏è Seeking forward to: ${newTime.toFixed(1)}s`)

        mainVideo.currentTime = newTime
        if (audioTranscoded) {
          audioTrack.currentTime = newTime + syncOffset
        }
      }

      function seekBackward() {
        const newTime = Math.max(0, mainVideo.currentTime - 30)
        log(`‚èÆÔ∏è Seeking backward to: ${newTime.toFixed(1)}s`)

        mainVideo.currentTime = newTime
        if (audioTranscoded) {
          audioTrack.currentTime = newTime + syncOffset
        }
      }

      function setSyncOffset(value) {
        syncOffset = parseFloat(value)
        document.getElementById('offset-display').textContent = `${syncOffset.toFixed(1)}s`

        // Apply offset immediately
        if (audioTranscoded && audioTrack.src) {
          audioTrack.currentTime = mainVideo.currentTime + syncOffset
          log(`üéµ Sync offset adjusted: ${syncOffset.toFixed(1)}s`)
        }
      }

      function setVolume(value) {
        if (audioTranscoded) {
          audioTrack.volume = parseFloat(value)
        } else {
          mainVideo.volume = parseFloat(value)
        }
        log(`üîä Volume: ${(value * 100).toFixed(0)}%`)
      }

      function stopBoth() {
        mainVideo.pause()
        if (audioTranscoded) audioTrack.pause()
        mainVideo.currentTime = 0
        if (audioTranscoded) audioTrack.currentTime = 0
        document.getElementById('video-container').style.display = 'none'
        log('‚èπÔ∏è Stopped')
      }

      function testDirectFirst() {
        log('üì∫ Testing direct playback first...')
        document.getElementById('video-container').style.display = 'block'

        mainVideo.src = videoUrl
        mainVideo.muted = false

        mainVideo.play().then(() => {
          log('‚úÖ Direct playback started')
          setTimeout(() => {
            const hasAudio = confirm('üîä Do you hear audio? (OK = Yes, Cancel = No)')
            if (hasAudio) {
              log('üéâ Direct audio working! No transcoding needed!')
              playbackStatus.innerHTML = 'üéâ Perfect! Direct playback with audio!'
            } else {
              log('‚ùå No audio - starting streaming solution...')
              startStreamingPlayback()
            }
          }, 3000)
        })
      }

      function clearLogs() {
        document.getElementById('log').innerHTML = ''
      }

      // Enhanced sync monitoring
      setInterval(() => {
        if (audioTranscoded && !mainVideo.paused && !audioTrack.paused) {
          updateSyncStatus()
        }
      }, 500) // Update twice per second

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        log('üéµ Streaming audio solution loaded')
        log('üéØ Goal: Perfect sync with seeking support')

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.target.tagName === 'INPUT') return // Don't interfere with inputs

          switch (e.code) {
            case 'Space':
              e.preventDefault()
              if (mainVideo.paused) {
                playBoth()
              } else {
                pauseBoth()
              }
              break
            case 'ArrowRight':
              e.preventDefault()
              seekForward()
              break
            case 'ArrowLeft':
              e.preventDefault()
              seekBackward()
              break
          }
        })

        log('‚å®Ô∏è Keyboard shortcuts: Space=Play/Pause, ‚Üê/‚Üí=Seek')
      })
    </script>
  </body>
</html>
